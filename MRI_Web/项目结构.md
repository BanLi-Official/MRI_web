# 项目结构与快速上手

本文档用于快速复盘本项目的整体结构、核心功能与关键入口，便于后续维护与二次分析。

## 1. 项目概况

- 技术栈：Django + SQLite（默认） + Bootstrap 前端样式
- 功能域：
  - 图像处理（MAT 文件上传→外部 API 推理→结果预览与指标）
  - 数据管理（数据类型/DataType、数据源/DataSource、数据文件/DataFile）
  - 上传进度（XHR 前端进度条 + 后端 UploadProgress 模型）
  - 文章展示（Article）
  - 用户认证与权限（登录/注册、RBAC：is_staff 管理员）

## 2. 目录结构速览

- 根目录：`/root/code/blog_project/`
  - `manage.py`：Django 管理入口
  - `settings.py`、`urls.py`：遗留顶层配置（实际以 `blog_project/` 子目录为准）
  - `requirements.txt`：依赖
  - `media/`：媒体文件（original/previews/processed 等）
  - `blog/` 应用
    - `models.py`：包含 Mask/ProcessedImage/Article/DataType/DataSource/DataFile/UploadProgress
    - `views.py`：业务视图（图像、数据管理、上传、注册、登录包装）
    - `forms.py`：表单
    - `admin.py`：Admin 配置
    - `urls.py`：App 路由
    - `tasks.py`：Celery 任务（process_image_task）
    - `templates/blog/`：页面模板（列表、详情、上传、进度演示等）
    - `templates/registration/`：登录/注册模板
  - `blog_project/`（实际生效的 Django 项目目录）
    - `settings.py`、`urls.py`、`wsgi.py`

提示：`manage.py` 指向 `blog_project.settings`，因此以 `blog_project/blog_project/urls.py` 为实际路由入口。

## 3. 认证与用户管理

- 路由与视图
  - 登录：`/login/` → `CustomLoginView(LoginView)`（模板：`registration/login.html`）
  - 登出：`/logout/` → `auth_views.LogoutView(next_page='/')`
  - 注册：`/register/` → `blog.views.register`（模板：`registration/register.html`）
  - 密码修改：`/password_change/`、`/password_change/done/`
- 模板
  - 登录页：用户名/密码、错误提示、注册引导
  - 注册页：使用 `CustomUserCreationForm`，保存后自动登录
- 配置
  - `LOGIN_URL='login'`，`LOGIN_REDIRECT_URL='/'`，`LOGOUT_REDIRECT_URL='/'`
- 行为要点
  - `CustomLoginView` 强制重定向到 `/`（忽略 next 参数），并在已登录时直接跳转首页
  - 注册成功后自动登录并回到图片列表
- 待优化
  - URL 配置重复：根目录 `urls.py` 与 `blog_project/urls.py` 同时存在，建议只保留后者
  - 恢复标准 next 跳转：移除 `get_redirect_url()` 覆盖以支持“登录后返回来源页”
  - 模板继承统一为 `blog/base.html`

## 4. 权限与界面差异（RBAC）

- 角色：
  - 普通用户（is_authenticated 且 is_staff=False）
  - 管理员（is_staff=True）
- 约束：
  - 写操作（图像/文章/数据源/文件 创建、编辑、删除、上传）需要 `login_required + is_staff`
  - 读操作（浏览/下载）对所有用户开放（私有数据源下载需要登录）
- UI 差异（模板中基于 `user.is_staff`）：
  - 管理员看到：管理后台入口、创建/编辑/上传/删除按钮、上传进度条页面
  - 普通用户仅浏览/下载且看不到管理操作；若通过 URL 访问写操作，后端拒绝并提示

## 5. 图像处理模块（一图速览）

- 模型：`ProcessedImage`
  - 字段：`original_image`(输入 .mat)、`processed_image`(输出 .mat)、`processing_status`(pending/processing/completed/failed)、`model_type`、`selected_mask`、三张预览(`input_preview/zero_filled_preview/output_preview`)、`psnr_value/ssim_value`
- 触发：新建 `ProcessedImage` 后，模型 `save()` 自动调用 `process_image()`（同步）
- 流程：
  1) 读取 `.mat`（取首个非 `__` 变量）→ 生成 `input_preview`
  2) 组织 `files={image(必), mask(可选)}`、`data={model_type}` 调用外部 API（URL 优先取 `settings.API_CONFIG[model_type]`，否则回退 ngrok 地址）
  3) 响应 `200`：
     - 读响应头 `X-PSNR/X-SSIM` 存为指标
     - 保存响应体 `.mat` 到 `processed_image`
     - 从结果 `.mat` 解析 `zeorfilled_data_sos`、`rec_Image_sos` → 生成 `zero_filled_preview`、`output_preview`
     - 状态置 `completed`
  4) 非 200 或异常：状态置 `failed`
- 备用通路：`views.process_image(pk)` 直连 `http://localhost:8001/process/`，但使用了不存在的字段名（应为 `zero_filled_preview/output_preview`），建议统一为模型内置通路或修正字段名。
- 注意事项：
  - 变量名拼写：代码中期望 `zeorfilled_data_sos`（疑似服务端拼写），需与服务端确认；可做兼容匹配
  - 同步阻塞：`process_image()` 在 `save()` 中同步调用外部 API，生产建议改为 Celery 异步
  - 证书校验：`requests` 关闭了 TLS 验证（`verify=False`），生产请开启

## 6. 数据管理系统

- 模型层：
  - `DataType`（MRI/PET/CT/…）
  - `DataSource`（与 DataType 关联，包含机构、质量、是否公开等）
  - `DataFile`（与 DataSource 关联，文件类型/大小/描述/标签/下载次数）
- 视图与模板：
  - 数据类型列表/详情：管理员可创建/编辑类型
  - 数据源列表/详情：管理员可创建数据源、为数据源上传/删除文件
  - 文件详情/下载：公开可下，私有需登录
- 上传进度（管理员专用）：
  - 页面：`data_file_upload.html`（XHR 原生进度，显示已传字节、速度、剩余时间、状态）
  - 后端：
    - `POST /data-files/upload/` 常规上传
    - `POST /data-files/upload-progress/` 带进度上传（返回 JSON）
    - `GET /data-files/progress/<upload_id>/` 查询进度（模型：`UploadProgress`）

## 7. 关键 URL 速查

- 登录：`/login/`（模板：`registration/login.html`）
- 登出：`/logout/`
- 注册：`/register/`（模板：`registration/register.html`）
- 图像列表：`/`（`blog:image_list`）
- 图像详情：`/image/<pk>/`
- 数据类型：`/data-types/`、`/data-types/<pk>/`
- 数据源：`/data-sources/`、`/data-sources/<pk>/`、创建/编辑（管理员）
- 文件：`/data-files/<pk>/`（详情）、`/data-files/<pk>/download/`（下载）、上传/删除（管理员）
- 上传演示：`/upload-demo/`、`/progress-test/`
- 管理后台：`/admin/`

## 8. 运行与开发

- 准备环境：
  - `conda create -n web python=3.10`
  - `pip install -r requirements.txt`
- 启动：
  - 前台：`python manage.py runserver 0.0.0.0:8000`
  - 后台：`nohup python manage.py runserver 0.0.0.0:8000 > nohup.out 2>&1 &`
- 管理员创建：`python manage.py createsuperuser`

## 9. 待改进清单（建议）

- 认证：恢复 next 跳转；清理重复 URL；统一模板继承；考虑加入密码找回流
- 权限显示：模板层将“上传新图像/发布新文章”按钮收紧到 `user.is_staff`
- 图像处理：
  - 统一处理通路（删除或修复 `views.process_image`）；
  - Celery 异步化处理；
  - 与服务端约定变量名，解析做兼容；
  - 对多维矩阵加切片/归一化策略；
  - 打开 TLS 校验并配置合理超时与重试。
- 代码整洁：统一 `scipy.io` 别名为 `sio`，避免与 Python `io` 混淆；减少重复逻辑到统一服务层。

---
以上内容覆盖了项目的关键结构与行为路径，可作为后续分析与开发的索引指南。

## 10. 数据库设计与模型关系

- 引擎与全局
  - ENGINE: sqlite3（`db.sqlite3`）
  - DEFAULT_AUTO_FIELD: BigAutoField
  - MEDIA_ROOT: `<PROJECT>/media`（FileField/ImageField 存储位置）

- 领域模型与关系（简式）
  - User 1—N DataSource.created_by
  - User 1—N DataFile.uploaded_by
  - Mask 1—N ProcessedImage.selected_mask（可选）
  - DataType 1—N DataSource
  - DataSource 1—N DataFile

- 表结构要点
  - Mask：name, description, mask_file, created_at
  - ProcessedImage：original_image, processed_image, created_at, processing_status, model_type, selected_mask(FK), input/zero_filled/output 预览图, psnr_value, ssim_value
  - Article：title, summary, keywords, url, image, content, created_time, modified_time
  - DataType：name(choices, unique), description, icon, color, created_at, updated_at
  - DataSource：data_type(FK), source_name(+type 唯一), 描述/机构/联系人/邮箱, collection_date, data_quality(choices), is_public, created_by(FK), created_at, updated_at
  - DataFile：data_source(FK), file_name, file(FileField), file_type(choices), file_size(保存时计算), 描述/患者/扫描时间/参数/标签, download_count, is_active(软删), uploaded_by(FK), created_at, updated_at
  - UploadProgress：upload_id(unique), user(FK), filename, file_size, uploaded_size, status, progress, upload_speed, estimated_time, error_message, created/updated

- 典型查询与约束
  - DataType 列表：annotate 源与文件计数，按 name 排序
  - DataSource 列表：is_public=True，支持类型/关键词/质量过滤与分页
  - DataSource 详情：DataFile(is_active=True) 分页
  - DataSource 唯一约束：`unique_together = ['data_type', 'source_name']`
  - DataFile 下载：`download_count` 自增；删除为软删（is_active=False）

- 数据生命周期与存储路径
  - ProcessedImage：original/processed/previews 三类目录；创建即触发外部 API，同步写入结果与预览
  - DataFile：上传即落地 `media/data_files/`，保存时写 `file_size`

- 迁移与演进
  - 迁移位于 `blog/migrations/`，包含字段新增/重命名/新增模型（如 UploadProgress）等演进历史

- 性能与扩展建议
  - 量大并发建议切换到 PostgreSQL，增加必要索引（如 DataSource.data_type、is_public、DataFile.data_source、is_active）
  - `download_count` 使用 F 表达式原子更新；统计可异步物化
  - 大文件上传可引入分片/断点续传；图像处理改为 Celery 异步

## 11. 用户注册与登录的数据库

- 认证应用与表
  - 使用 Django 内置认证：`django.contrib.auth`、`django.contrib.sessions`
  - 核心表：
    - `auth_user`：username(唯一), password(哈希), email, is_staff, is_superuser, is_active, last_login, date_joined
    - `django_session`：session_key, session_data, expire_date
    - 权限/分组相关：`auth_group`、`auth_permission`、关联表（本项目未显式使用）

- 注册落库流程
  - 视图：`blog/views.py::register`；表单：`CustomUserCreationForm`
  - 创建 `auth_user`：用户名唯一、密码 PBKDF2-SHA256 哈希、email 存储、强制 `is_staff=False`/`is_superuser=False`
  - 注册成功后调用 `login()` 创建会话，插入/更新 `django_session`

- 登录读写流程
  - 校验用户名/密码（比对哈希）；成功后更新 `auth_user.last_login`
  - 写入/刷新 `django_session` 并下发 `sessionid` Cookie
  - 本项目 `CustomLoginView` 登录成功后强制重定向 `/`（忽略 next 参数）

- 登出
  - 使用 `LogoutView`：清理 `django_session`，重定向 `/`

- 管理员与权限标记
  - 管理员：`auth_user.is_staff=1`（控制写操作权限）
  - 超级用户：`is_superuser=1`（Django Admin 全权）
  - 普通注册用户由表单确保非管理员/非超级用户

- 安全与策略
  - 密码校验器：最小长度/常见密码/纯数字校验（见 `AUTH_PASSWORD_VALIDATORS`）
  - CSRF 开启；会话基于 `django_session`
  - 可选增强：邮箱唯一约束、登录失败审计（如 django-axes）、Redis 会话、启用密码找回流